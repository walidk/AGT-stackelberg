\input{packages.tex}
\input{commands}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage[utf8]{inputenc}
%\usepackage[french]{babel}
\usepackage{graphicx}
\usepackage{hyperref}
\hypersetup{bookmarks=false, pdfborder={0 0 0}, colorlinks=true, linktoc=all}


\title{Stackelberg strategies for transportation networks}
%\author{Walid Krichene}
\date{\today}


\begin{document}
\maketitle


%#########################################################################################################################
\begin{abstract}
We study inefficiencies of transportation networks due to the selfish behaviour of drivers, by comparing social optimal equilibria to Nash equilibria. Then we investigate possible strategies to reduce the inefficiency by studying the Stackelberg routing game: assuming we have control over a fraction of the flow on the network, what is a good way of routing that compliant flow so that the induced Nash equilibrium is closer to the social optimum than the initial Nash equilibrium? Stackelberg scheduling on parallel link networks has been studied in a non-transportation setting, and it is shown in ~\cite{rou01} that computing the optimal Stackelberg assignment is NP-hard in the number of links. Approximate polynomial time strategies such as Largest Latency First are proposed and bounds on the inefficiency are shown for those strategies.
We first describe the problem in the specific setting of transportation networks, where the dynamics of flow result in latency functions that do not satisfy common properties assumed in the literature studying Stackelberg scheduling. We then characterize Nash equilibria for our network and show that there are multiple such equilibria. Then we study the Stackelberg game and describe optimal Stackelberg strategy in the case of 2 link networks, and show results for general parallel link networks.
\end{abstract}


%#########################################################################################################################
\section{The Model}
\subsection{Traffic flows}
We consider a network of $N$ parallel links indexed by $n \in \{1, \dots, N \}$, under constant positive flow demand, or rate $r$. The flow $q_n$ on link $n$ is a function of the density $\rho_n$, given by a triangular fundamental diagram with the following parameters
\begin{itemize}
\item $v_n$ the free-flow speed on the link
\item $w_n$ the congestion wave speed
\item $q_n^{\max}$ the maximum capacity of the link
\end{itemize}
In the free flow regime (when the density on the link is less than a critical density $\rho_n^c$ that is given by $v_n\rho_n^c = q_n^{\max}$) the velocity is constant and the flow increases linearly in the density $q_n = v_n \rho_n$. In the congested regime ($\rho_n > \rho_n^c$), the flow decreases linearly in the density $q_n = q_n^{\max} - w_n(\rho_n - \rho_n^c)$ and the velocity is decreasing.

\begin{align*}
q_n = 
\begin{cases}
v_n \rho_n & \rho_n \leq \rho_n^c\\
q_n^{\max} - w_n(\rho_n - \rho_n^c) & \rho_n > \rho_n^c
\end{cases}
\end{align*}

Note that the flow can aso be written succinctly as
\[
q_n = \min \{ v_n \rho_n, q_n^{\max} - w_n(\rho_n - \rho_n^c)\}
\]

We denote by $(N, r)$ a network instance with $N$ links, rate $r$, and no compliant flow. We next define feasible flow assignments for network instance $(N, r)$.

\begin{definition}
A flow assignment $q \in \mathbb{R}_+^N$ is feasible for instance $(N, r)$ if $\forall n$ $q_n \leq q_n^{\max}$ and $\sum_n q_n = r$
\end{definition}

If $q$ is a feasible flow assignment for $(N, r)$, we denote by $Supp(q)$ the support of $q$, that is the set of links that are used by the flow assignment
\[
Supp(q) = \{ n | q_n >0 \}
\]

\subsection{Steady state equilibria}
We are interested in the steady state equilibria of the network under constant positive rate $r$. In the steady state equilibria the flow and density variables are static.

\subsection{Latency function}
The velocity on link $n$ is given by $q_n/\rho_n$, and the individual latency function is
\[
l_n(\rho_n) = \frac{L_n\rho_n}{q_n} 
\]

where $L_n$ is the length of link $n$.
Note that $l_n$ is an increasing function of density, but not of flow. We can express the latency as a function of flow by introducing an integer $m_n \in \{0, 1\}$ that specifies whether link $n$ is congested ($m_n = 1$ if $n$ is congested and $m_n = 0$ if $n$ is free-flow)
\[
\rho_n(q_n, m_n) = m_n \left( \rho_n^c + \frac{q_n^{\max} - q_n}{w_n} \right) + (1-m_n)\frac{q_n}{v_n}
\]
this corresponds to inverting the fundamental diagram that gives the flow as a function of density. The latency is then given by
\[
l_n(q_n, m_n) = \frac{L_n}{q_n} \left( m_n \left( \rho_n^c + \frac{q_n^{\max} - q_n}{w_n} \right) + (1-m_n)\frac{q_n}{v_n} \right)
\]

The total latency incurred by all users on a link is $q_n l_n(\rho_n) = L_n \rho_n$, and the total latency incurred by all users on the network is
\[
C(\rho) = \sum_n L_n \rho_n = L^T\rho
\]

\paragraph{Note} The latency function does not satisfy properties usually assumed in the Stackelberg scheduling literature. In particular, the latency $l_n(q_n)$ is not an increasing function of flow: it is a constant function if the link is in free-flow, and a \emph{decreasing} function when the link is congested.
\begin{align*}
l_n(q_n, 0) &= \frac{L_n}{v_n}\\
l_n(q_n, 1) &= L_n \left( \rho_n^c + \frac{1}{w_n}(\frac{q_n^{\max}}{q_n} - 1) \right)
\end{align*}

And for a given flow $q_n$, there are up to two possible latencies, one corresponding to the free-flow regime (few cars on the link moving fast) and one to the congested regime (many cars on the link moving slowly).

As a consequence, some of the known results on congestion networks do not apply to our setting: for instance, the network has multiple Nash equilibria that have different costs. In the next section we specify this result and address the issue of having multiple pure Nash equilibria.



%#########################################################################################################################
\section{Nash Equilibria}
In this section we characterize pure Nash equilibria of the network, which we simply refer to as Nash equilibria. We first review the essential uniqueness of Nash equilibria in the case of increasing latency functions (in the sense that all Nash equilibria have the same cost). Then we show that latency functions consistent with the fundamental diagram of traffic induce multiple Nash equilibria with different costs, and we analytically solve for Nash equilibria for $(N = 2, r)$ instances, and give some results describing Nash equilibria for $(N>2, r)$ instances.

\subsection{Characterization of Nash equilibria}

\begin{definition}
An assignment $(q, m)$ for instance $(N, r)$ is at Nash equilibrium if $\forall n$
\[
q_n > 0 \Rightarrow \forall k, l_n(q_n, m_n) \leq l_k(q_k, m_k)
\]
\end{definition}

In particular, every (non-atomic) user cannot improve her latency by switching to another link. As a consequence, all links that are in the support of $q$ have the same latency $l_0$, and links that are not in the support have latency greater than $l_0$. Note that to fully characterize the equilibrium one needs to specify the congestion state $m$, since the latency on a link depends on whether the link is congested.

\begin{lemma}
\label{lemma:nash_eq}
If $(q, m)$ is an assignment for instance $(N, r)$ at Nash equilibrium, then
\begin{align*}
q_n >0 &\Rightarrow l_n(q_n, m_n) = l_0\\
q_n = 0 &\Rightarrow l_n(0, 0) \geq l_0
\end{align*}
and the total latency incurred by the network is $C(q, m) = r l_0$.
\end{lemma}

Note that links that have zero flow are necessarily in free-flow $q_n = 0 \Rightarrow m_n = 0$.

\subsection{Nash equilibria for increasing latency functions}
Assuming the latency functions $q_n \rightarrow l_n(q_n)$ are increasing, one can show that all Nash equilibria have the same cost. Let $q$ and $q'$ be two assignments for $(N, r)$ at Nash equilibrium.  Let $l_0$, respectively $l'_0$ denote the common latency of all links in the support of $q$, respectively $q'$. The cost of the Nash equilibria are respectively $rl_0$ and $rl'_0$.

Assume $q \neq q'$. Then $\exists n_1, n_2$ such that
\begin{align*}
q_{n_1} > q'_{n_1} \geq 0 && q'_{n_2} > q_{n_2} \geq 0
\end{align*}

Since $q$ is at Nash equilibrium and $n_1 \in Supp(q)$, $l_{n_1}(q_{n_1}) \leq l_{n_2}(q_{n_2})$. And since $l_{n_2}$ is increasing $l_{n_2}(q_{n_2}) \leq l_{n_2}(q'_{n_2})$. Thus $l_0 = l_{n_1}(q_{n_1}) \leq l_{n_2}(q_{n_2}) \leq l_{n_2}(q'_{n_2}) = l'_0$. Exchanging the roles of $q$ and $q'$ we have $l'_0 \leq l_0$. Therefore $l_0 = l'_0$ and both equilibria have the same cost.

\subsection{Traffic networks have multiple Nash equilibria}
To simplify our discussion, we further assume, without loss of generality, that the links are ordered from the least to most free-flow latencies
\[
\frac{L_1}{v_1} \leq \frac{L_2}{v_2} \leq \dots \leq \frac{L_N}{v_N}
\]



\subsection{Nash equilibria for 2-parallel link networks}
We consider a $(2, r)$ instance. We characterize the Nash equilibria of the network depending on the flow demand $r$.

\subsubsection{Equal free-flow latencies}

\subsubsection{Different free-flow latencies}



\subsection{Price of Anarchy for the best Nash Equilibrium in the 2-link case}


\subsection{Nash equilibria for general parallel link networks}
We consider a $(N, r)$ instance where $N \geq 2$. We further assume that the free-flow latencies are different to avoid degenerate cases where the set of Nash equilibria is infinite
\[
\frac{L_1}{v_1} < \frac{L_2}{v_2} < \dots < \frac{L_N}{v_N}
\]

Under this assumption, we show that there are a least 2 Nash equilibria, one purely congested, and one where there is a single link in free flow, and show that there are at most $N$ equilibria.



\subsection{Computing the best Nash Equilibrium}


\subsection{Price of Anarchy for the best Nash Equilibrium}




%#########################################################################################################################
\section{Social Optimal equilibria}
The social optimal steady state equilibrium of the network is a solution to the following optimization problem $(SO)$
\begin{align*}
\min_{\rho, q}  &\sum_n L_n \rho_n\\
\text{subject to }
& \sum_n q_n = r\\
& q_n = \min \{ v_n \rho_n, q_n^{\max} - w_n(\rho_n - \rho_n^c)\}
\end{align*}

This problem is non convex due to the second flow constraint $q_n = f(\rho_n) = \min \{ v_n \rho_n, q_n^{\max} - w_n(\rho_n - \rho_n^c)\}$
which corresponds to the fundamental diagram of traffic. However, we show that the solutions to this optimization problem are necessarily in free-flow ($q_n = v_n \rho_n$), thus the social optimum can be computed by solving an equivalent linear program.


\begin{lemma}
\label{lemma:relaxedTTT_is_ff}
$(\rho^*, q^*)$ is optimal for $(SO)$ only if $q^*_n = v_n \rho^*_n \forall n$
\end{lemma}


\begin{proof}
Let $( \rho,  q)$ be a feasible point for $(SO)$, and suppose that $\exists k$ such that $q_k < v_k \rho_k$. We show that $\exists$ feasible point $(\bar{ \rho}, \bar{ q})$ such that $C(\bar{ \rho}) < C( \rho)$.
Let
\begin{align*}
\bar{q} &= q\\
\bar{\rho}_k &= \frac{q_k}{v_k}\\
\bar{\rho_n} &= \rho_n \forall n \neq k
\end{align*}
Then we have $C(\bar{ \rho}) < C( \rho)$ since $\bar{\rho}_k = \frac{q_k}{v_k} < \rho_k$ and $\bar{\rho}_n = \rho_n \forall n \neq k$.

And since $\bar{q}_k = \bar{\rho}_k v_k$, and $\bar{q}_k = q_k \leq q_k^{\max} - w_k(\rho_k - \rho_n^c) \leq q_k^{\max} - w_k(\bar{\rho}_k - \rho_n^c)$, then
\[
\bar{q}_k = \min \{ \bar{\rho}_k v_k,  q_k^{\max} - w_k(\bar{\rho}_k - \rho_n^c) \}
\]
and the constraint $\bar{q}_k = f(\bar{\rho}_k)$ is satisfied. All other constraints trivially hold.

Therefore, $(\bar{ \rho}, \bar{ q})$ is feasible for $(SO)$, and $( \rho,  q)$ is non optimal. This shows that $( \rho^*,  q^*)$ is optimal only if $q^*_n = v_n \rho^*_n$ which completes the proof.
\end{proof}

\bigskip

As an immediate corollary of the previous Lemma, the social optimum can be computed by solving the following equivalent linear program
\begin{align*}
\min_{\rho, q}  &\sum_n L_n \rho_n\\
\text{subject to } & 
\sum_n q_n = r\\
& q_n \leq v_n \rho_n\\
& q_n \leq q_n^{\max}
\end{align*}



%#########################################################################################################################
\section{Stackelberg assignment}
In order to reduce the inefficiency of the network, we assume that a fraction of the flow is centrally controlled, and we investigate possible strategies for improving the equilibria of the network. 


\subsection{Valid Stackelberg strategy}
We consider the following problem: given a network under constant flow demand $r$, assume a coordinator (a central authority) has control over a fraction $\beta$ of the flow: the corresponding users are compliant and willing to change their routes according to the instructions thy are given. The coordinator (who plays the role of the leader in the Stackelberg game) assigns the compliant flow $\beta r$ according to a Stackelberg strategy $s$ that is a feasible flow assignment for instance $(N, \beta r)$, i.e. $s$ satisfies
\begin{align*}
s_n \leq q_n^{\max} \forall n && \sum_n s_n = \beta r
\end{align*}

We assume that the non compliant users (who play the role of followers in the Stackelberg game), with corresponding flow $(1-\beta)r$, choose their routes selfishly after the Stackelberg assignment $s$ of compliant users is revealed. This induces an assignment $(t(s), m(s))$ of the selfish flow at Nash equilibrium, and we assume that the assignment $s$ of compliant users \emph{is not affected} after introducing the non-compliant flow on the network. Note that the Nash assignment (t, m) depends on the Stackelberg strategy $s$.

To characterize the final Nash equilibrium, which we refer to as the \emph{induced equilibrium} by strategy $s$, we note that the flow on link $n$ is simply $s_n + t_n(s)$, and we have $\forall n$
\[
t_n > 0 \Rightarrow \forall k, l_n \left( s_n + t_n(s), m_n(s) \right) \leq l_k \left( s_k + t_k(s), m_k(s) \right)
\]
and by lemma~\ref{lemma:nash_eq}, all links that are used by selfish users have a common latency $l_0$ in the induced equilibrium, and links that are not used by the selfish flow have latency greater than $l_0$.

This can be summarized in the following definition of a valid Stackelberg strategy


\begin{definition}
A valid Stackelberg strategy is an assignment $s$ of the compliant flow $\beta r$ that is feasible for the instance $(N, \beta r)$, and which induces a Nash assignment $(t(s), m(s))$ of the non-compliant flow that satisfies
\begin{align*}
\forall n \in Supp \left( t(s) \right),\, &l_n \left( s_n + t_n(s), m_n(s) \right) = l_0 \\
\forall n \notin Supp \left( t(s) \right),\, &l_n \left( s_n, m_n(s) \right) \geq l_0
\end{align*}
\end{definition}



\subsection{Example of an invalid Stackelberg strategy} Note that a feasible flow assignment $s$ may fail to induce a Nash assignment $t$ that does not affect the initial compliant assignment $s$.

To see this, consider the following 2-link network where links have the same length $L_1 = L_2 = 1$, link 1 has greater free-flow speed and capacity than link $2$ $v_1 > v_2$, $q_1^{\max} > q_2^{\max}$, and both links have same congestion wave speed $w_1 = w_2$.
Now assume that the network is subject to flow demand $r = q_1^{\max} + \epsilon$ and most of the flow is compliant $\alpha r = q_1^{\max}$. Consider the following Stackelberg strategy: $s = (q_1^{\max}, 0)$.

Assuming that the assignment of compliant users is not affected by introducing the non-compliant flow, we have for any assignment $t$ of non-compliant flow, $t_1 = 0$ and $t_2 > 0$. Therefore $t$ is not a Nash assignment since $Supp(t) = \{ 2 \}$ and $l_2(s_2 + t_2) > l_1(s_1)$ (non compliant users are forced to use less efficient link 2).

In practice, strategy $s$ may induce a steady state equilibrium in which the compliant flow is some assignment $s'$: when non-compliant flow is introduced on the network, drivers will choose link 1 even though it is at maximum flow. This will result in congesting the link $\rho_1 > \rho_1^c$ and the flow on link 1 will \emph{decrease} due to congestion. Now a fraction of the compliant flow will not be able to use link 1, and will be forced to use link 2. Therefore, in the final equilibrium, the compliant flow will be $s' = (s'_1, s'_2)$ such that $l_1(s'_1, 1) = l_2(s_2' + \epsilon, 0)$, link 1 will be congested in the final equilibrium, and link 2 in free flow. Note that such a strategy $s$ is not considered as a valid Stackelberg assignment in our definition, we only consider strategies that induce assignment $s + t$ where $t$ is a Nash assignment as described above.









%#########################################################################################################################
\section{Optimal Stackelberg equilibrium}

In this section we solve for optimal Stackelberg assignments, i.e. Stackelberg assignments that induce Nash equilibria of optimal cost. This is described by the following optimization problem
\begin{align*}
\min_s C\left( s + t(s), m(s) \right)
\end{align*}
where $s$ is a \emph{valid} Stackelberg assignment and $(t(s), m(s))$ is the non-compliant flow assignment at the equilibrium induced by $s$.

We define an optimal Stackelberg strategy $s^*$ to be a solution to the optimization problem
\begin{align*}
s^* = \arg \min_s C\left( s + t(s), m(s) \right)
\end{align*}
and a Stackelberg equilibrium to be the Nash assignment $(t(s^*), m(s^*))$ induced by $s*$.


\bigskip
We first study the 2 link case and solve analytically for the optimal Stackelberg strategy, then

\subsection{The 2-link case}

\subsection{General case}



\section{Approximate strategies}


%#########################################################################################################################
\begin{thebibliography}{8}

\bibitem{pap10}
  C. Papadimitriou and G. Valiant. A new Look at Selfish Routing. In
  \emph{Innovations in Computer Science, 2010}.

\bibitem{rou01}
	T. Roughgarden. Stackelberg Scheduling Strategies. In \emph{Proceedings of the 33rd Annual ACM Symposium on the Theory of Computing, 2001}

\end{thebibliography}

\end{document}